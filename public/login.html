<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 - Channel Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Channel Manager</h1>

    <div id="loginForm">
      <h2 class="text-xl font-semibold mb-4">로그인</h2>
      <form onsubmit="handleLogin(event)">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
          <input type="email" id="loginEmail" required
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-6">
          <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
          <input type="password" id="loginPassword" required
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <button type="submit"
          class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold">
          로그인
        </button>
      </form>

      <p class="text-center mt-4 text-sm text-gray-600">
        계정이 없으신가요?
        <a href="#" onclick="showSignup(); return false;" class="text-blue-600 hover:underline">회원가입</a>
      </p>
    </div>

    <div id="signupForm" class="hidden">
      <h2 class="text-xl font-semibold mb-4">회원가입</h2>
      <form onsubmit="handleSignup(event)">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
          <input type="email" id="signupEmail" required
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호 (최소 6자)</label>
          <input type="password" id="signupPassword" required minlength="6"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호 확인</label>
          <input type="password" id="signupPasswordConfirm" required minlength="6"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">가입 유형</label>
          <div class="space-y-2">
            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
              <input type="radio" name="signupType" value="owner" checked
                class="mr-3 w-4 h-4 text-blue-600">
              <div>
                <div class="font-semibold">새 숙소 등록 (오너)</div>
                <div class="text-xs text-gray-500">새로운 숙소를 등록하고 관리합니다</div>
              </div>
            </label>
            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
              <input type="radio" name="signupType" value="staff"
                class="mr-3 w-4 h-4 text-blue-600">
              <div>
                <div class="font-semibold">기존 숙소 참여 (스태프)</div>
                <div class="text-xs text-gray-500">다른 사람의 숙소에 스태프로 참여합니다</div>
              </div>
            </label>
          </div>
        </div>

        <div id="orgNameField" class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">숙소 이름</label>
          <input type="text" id="organizationName"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="예: 다우하우스">
        </div>

        <div id="inviteCodeField" class="mb-4 hidden">
          <label class="block text-gray-700 text-sm font-bold mb-2">초대 코드 <span class="text-red-500">*</span></label>
          <input type="text" id="inviteCode"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="숙소 관리자에게 받은 초대 코드를 입력하세요">
          <p class="text-xs text-gray-500 mt-1">스태프 가입은 초대 코드가 필수입니다</p>
        </div>

        <button type="submit"
          class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 font-semibold">
          가입하기
        </button>
      </form>

      <p class="text-center mt-4 text-sm text-gray-600">
        이미 계정이 있으신가요?
        <a href="#" onclick="showLogin(); return false;" class="text-blue-600 hover:underline">로그인</a>
      </p>
    </div>

    <div id="message" class="mt-4 p-3 rounded hidden"></div>
  </div>

  <script>
    const API_URL = window.location.origin;

    function showLogin() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
    }

    function showSignup() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');

      // Add event listener for signup type toggle
      document.querySelectorAll('input[name="signupType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const orgNameField = document.getElementById('orgNameField');
          const inviteCodeField = document.getElementById('inviteCodeField');

          if (e.target.value === 'owner') {
            orgNameField.classList.remove('hidden');
            inviteCodeField.classList.add('hidden');
            document.getElementById('organizationName').required = true;
            document.getElementById('inviteCode').required = false;
          } else {
            orgNameField.classList.add('hidden');
            inviteCodeField.classList.remove('hidden');
            document.getElementById('organizationName').required = false;
            document.getElementById('inviteCode').required = true;
          }
        });
      });
    }

    function showMessage(text, isError = false) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `mt-4 p-3 rounded ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
      messageEl.classList.remove('hidden');

      setTimeout(() => {
        messageEl.classList.add('hidden');
      }, 5000);
    }

    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (!response.ok) {
          // Check for pending approval
          if (data.pending) {
            showMessage('계정이 승인 대기 중입니다. 관리자의 승인을 기다려주세요.', true);
            return;
          }

          // Check for deactivated account
          if (data.deactivated) {
            showMessage('계정이 비활성화되었습니다. 관리자에게 문의하세요.', true);
            return;
          }

          throw new Error(data.error || '로그인 실패');
        }

        // 토큰 및 역할 정보 저장
        localStorage.setItem('auth_token', data.session.access_token);
        localStorage.setItem('user', JSON.stringify(data.user));
        localStorage.setItem('user_role', data.role);
        localStorage.setItem('user_status', data.status);
        localStorage.setItem('organization_id', data.organization_id);

        showMessage('로그인 성공! 리다이렉트 중...');

        // 역할에 따라 페이지 이동
        setTimeout(() => {
          if (data.role === 'STAFF') {
            window.location.href = '/staff.html';
          } else {
            window.location.href = '/';
          }
        }, 1000);
      } catch (error) {
        showMessage(error.message, true);
      }
    }

    async function handleSignup(event) {
      event.preventDefault();

      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
      const signupType = document.querySelector('input[name="signupType"]:checked').value;
      const organizationName = document.getElementById('organizationName').value;
      const inviteCode = document.getElementById('inviteCode').value;

      // 비밀번호 확인
      if (password !== passwordConfirm) {
        showMessage('비밀번호가 일치하지 않습니다.', true);
        return;
      }

      // 오너인 경우 숙소 이름 필수
      if (signupType === 'owner' && !organizationName) {
        showMessage('숙소 이름을 입력해주세요.', true);
        return;
      }

      // 스태프인 경우 초대 코드 필수
      if (signupType === 'staff' && !inviteCode) {
        showMessage('초대 코드를 입력해주세요.', true);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/auth/signup`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email,
            password,
            signupType,
            organizationName,
            inviteCode
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || '회원가입 실패');
        }

        // 회원가입 성공 - 자동 로그인
        if (data.session) {
          localStorage.setItem('auth_token', data.session.access_token);
          localStorage.setItem('user', JSON.stringify(data.user));
          localStorage.setItem('user_role', data.role);
          localStorage.setItem('user_status', data.status);
          localStorage.setItem('organization_id', data.organization_id);

          showMessage('회원가입 성공! 로그인되었습니다.');

          setTimeout(() => {
            if (data.role === 'STAFF') {
              window.location.href = '/staff.html';
            } else {
              window.location.href = '/';
            }
          }, 1000);
        } else {
          // 승인 대기
          showMessage(data.message || '회원가입이 완료되었습니다. 관리자 승인 후 로그인 가능합니다.');
          setTimeout(() => {
            showLogin();
            document.getElementById('loginEmail').value = email;
          }, 3000);
        }
      } catch (error) {
        showMessage(error.message, true);
      }
    }

    // 이미 로그인된 경우 메인 페이지로 리다이렉트
    if (localStorage.getItem('auth_token')) {
      window.location.href = '/';
    }
  </script>
</body>
</html>
